<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KinoPlayer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
        }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .search-box {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid var(--tg-theme-button-color, #667eea);
            border-radius: 12px;
            margin-bottom: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .menu-btn {
            padding: 20px;
            background: var(--tg-theme-button-color, #667eea);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .menu-btn:active { transform: scale(0.95); }
        .films-grid { display: grid; gap: 15px; }
        .film-card {
            display: flex;
            gap: 15px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
        }
        .film-poster {
            width: 80px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--tg-theme-button-color, #667eea);
        }
        .film-info { flex: 1; }
        .film-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        .film-meta { font-size: 14px; color: var(--tg-theme-hint-color, #999); }
        .loading { text-align: center; padding: 40px; font-size: 18px; }
    </style>
</head>
<body>
    <div class="header"><h1>üé¨</h1></div>
    <input type="text" class="search-box" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ —Ñ–∏–ª—å–º–∞...">
    <div class="menu-grid">
        <button class="menu-btn" onclick="loadPopular()">üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</button>
        <button class="menu-btn" onclick="loadTop250()">‚≠ê –¢–æ–ø 250</button>
        <button class="menu-btn" onclick="loadNew()">üé¨ –ù–æ–≤–∏–Ω–∫–∏</button>
        <button class="menu-btn" onclick="loadRandom()">üéØ –°–ª—É—á–∞–π–Ω—ã–π</button>
    </div>
    <div id="filmsContainer" class="films-grid"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const API_KEY_DECODED = atob('MGZmM2QzNTUtZjFkNS00MmMyLWJiMDYtZGY0ODJlZTViNjVi');

        let searchTimeout;
document.getElementById('tg-search').addEventListener('input', function(e) {
  clearTimeout(searchTimeout);
  const val = e.target.value.trim();
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã
  if (!val || val.length < 2) {
    document.getElementById('tg-search-results').innerHTML = '';
    document.getElementById('tg-film-grid').style.display = '';
    return;
  }
  
  searchTimeout = setTimeout(async () => {
    showLoader();
    const url = `${API_BASE}/v2.1/films/search-by-keyword?keyword=${encodeURIComponent(val)}&page=1`;
    
    try {
      const res = await apiGet(url);
      const results = res.films || res.items || [];
      
      if (results.length === 0) {
        document.getElementById('tg-search-results').innerHTML = '<div style="text-align:center;padding:40px;color:#888;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
      } else {
        displayFilms(results, true);
      }
      
      document.getElementById('tg-film-grid').style.display = 'none';
    } catch (error) {
      console.error('Search error:', error);
      alert('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message);
    } finally {
      hideLoader();
    }
  }, 450);
});

function triggerSearch() {
  const val = document.getElementById('tg-search').value.trim();
  if(val.length >= 2) {
    document.getElementById('tg-search').dispatchEvent(new Event('input'));
  } else {
    alert('–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞');
  }
}

        async function searchFilms(query) {
            showLoading();
            try {
                const response = await fetch(`https://kinopoiskapiunofficial.tech/api/v2.1/films/search-by-keyword?keyword=${query}`, {
                    headers: { 'X-API-KEY': API_KEY_DECODED }
                });
                const data = await response.json();
                displayFilms(data.films || []);
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
            }
        }

        async function loadPopular() {
            showLoading();
            try {
                const response = await fetch('https://kinopoiskapiunofficial.tech/api/v2.2/films/top?type=TOP_100_POPULAR_FILMS&page=1', {
                    headers: { 'X-API-KEY': API_KEY_DECODED }
                });
                const data = await response.json();
                displayFilms(data.films || []);
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            }
        }

        async function loadTop250() {
            showLoading();
            try {
                const response = await fetch('https://kinopoiskapiunofficial.tech/api/v2.2/films/top?type=TOP_250_BEST_FILMS&page=1', {
                    headers: { 'X-API-KEY': API_KEY_DECODED }
                });
                const data = await response.json();
                displayFilms(data.films || []);
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            }
        }

        async function loadNew() {
            showLoading();
            try {
                const response = await fetch('https://kinopoiskapiunofficial.tech/api/v2.2/films/premieres?year=2025&month=NOVEMBER', {
                    headers: { 'X-API-KEY': API_KEY_DECODED }
                });
                const data = await response.json();
                displayFilms(data.items || []);
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            }
        }

        async function loadRandom() {
            showLoading();
            try {
                const page = Math.floor(Math.random() * 10) + 1;
                const response = await fetch(`https://kinopoiskapiunofficial.tech/api/v2.2/films/top?type=TOP_250_BEST_FILMS&page=${page}`, {
                    headers: { 'X-API-KEY': API_KEY_DECODED }
                });
                const data = await response.json();
                const films = data.films || [];
                if (films.length > 0) {
                    const randomFilm = films[Math.floor(Math.random() * films.length)];
                    openPlayer(randomFilm.filmId || randomFilm.kinopoiskId, randomFilm.nameRu || randomFilm.nameEn);
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            }
        }

        function displayFilms(films) {
            const container = document.getElementById('filmsContainer');
            container.innerHTML = '';
            films.slice(0, 10).forEach(film => {
                const filmId = film.filmId || film.kinopoiskId;
                const title = film.nameRu || film.nameEn || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                const year = film.year || '–ù/–î';
                const rating = film.rating || '–ù/–î';
                const poster = film.posterUrlPreview || '';

                const card = document.createElement('div');
                card.className = 'film-card';
                card.onclick = () => openPlayer(filmId, title);
                card.innerHTML = `
                    <img class="film-poster" src="${poster}" alt="${title}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%22120%22%3E%3Crect fill=%22%23667eea%22 width=%22100%25%22 height=%22100%25%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2230%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22%3Eüé¨%3C/text%3E%3C/svg%3E'">
                    <div class="film-info">
                        <div class="film-title">${title}</div>
                        <div class="film-meta">üìÖ ${year} ‚Ä¢ ‚≠ê ${rating}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openPlayer(filmId, title) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º JavaScript –Ω–∞–≤–∏–≥–∞—Ü–∏—é –≤–º–µ—Å—Ç–æ <a href>
            const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '');
            window.location.href = `${baseUrl}player.html?id=${filmId}&title=${encodeURIComponent(title)}`;
        }

        function showLoading() {
            document.getElementById('filmsContainer').innerHTML = '<div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        }

        function showError(message) {
            document.getElementById('filmsContainer').innerHTML = `<div class="loading">‚ùå ${message}</div>`;
        }

        loadPopular();
    </script>
</body>
</html>
