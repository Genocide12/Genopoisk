<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KinoPlayer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            overflow-x: hidden;
        }
        .container { padding: 20px; }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .search-box {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid var(--tg-theme-button-color, #667eea);
            border-radius: 12px;
            margin-bottom: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .menu-btn {
            padding: 20px;
            background: var(--tg-theme-button-color, #667eea);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .menu-btn:active { transform: scale(0.95); }
        .films-grid {
            display: grid;
            gap: 15px;
        }
        .film-card {
            display: flex;
            gap: 15px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
        }
        .film-poster {
            width: 80px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--tg-theme-button-color, #667eea);
        }
        .film-info { flex: 1; }
        .film-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        .film-meta { font-size: 14px; color: var(--tg-theme-hint-color, #999); }
        .loading { text-align: center; padding: 40px; font-size: 18px; }
        
        /* –ü–ª–µ–µ—Ä */
        .player-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 1000;
        }
        .player-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1001;
        }
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
        }
        .player-title {
            color: white;
            font-size: 16px;
            flex: 1;
        }
        .player-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <div class="header">
            <h1>üé¨ KinoPlayer</h1>
        </div>

        <input type="text" class="search-box" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ —Ñ–∏–ª—å–º–∞...">

        <div class="menu-grid">
            <button class="menu-btn" onclick="loadPopular()">üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</button>
            <button class="menu-btn" onclick="loadTop250()">‚≠ê –¢–æ–ø 250</button>
            <button class="menu-btn" onclick="loadNew()">üé¨ –ù–æ–≤–∏–Ω–∫–∏</button>
            <button class="menu-btn" onclick="loadRandom()">üéØ –°–ª—É—á–∞–π–Ω—ã–π</button>
        </div>

        <div id="filmsContainer" class="films-grid"></div>
    </div>

    <!-- –ü–ª–µ–µ—Ä -->
    <div class="player-overlay" id="playerOverlay">
        <div class="player-header">
            <button class="back-btn" onclick="closePlayer()">‚Üê</button>
            <div class="player-title" id="playerTitle"></div>
        </div>
        <iframe class="player-frame" id="playerFrame" allowfullscreen></iframe>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.onClick(() => {
            if (document.getElementById('playerOverlay').style.display === 'block') {
                closePlayer();
            } else {
                tg.close();
            }
        });

        const API_KEY = 'MGZmM2QzNTUtZjFkNS00MmMyLWJiMDYtZGY0ODJlZTViNjVi';
        const API_KEY_DECODED = atob(API_KEY);

        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (e.target.value.trim()) {
                    searchFilms(e.target.value);
                }
            }, 500);
        });

        async function searchFilms(query) {
            showLoading();
            try {
                const response = await fetch(`https://kinopoiskapiunofficial.tech/api/v2.1/films/search-by-keyword?keyword=${query}`, {
                    headers: { 'X-API-KEY': API_KEY_DECODED }
                });
                const data = await response.json();
                displayFilms(data.films || []);
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
            }
        }

        async function loadPopular() {
            showLoading();
            try {
                const response = await fetch('https://kinopoiskapiunofficial.tech/api/v2.2/films/top?type=TOP_100_POPULAR_FILMS&page=1', {
                    headers: { 'X-API-KEY': API_KEY_DECODED }
                });
                const data = await response.json();
                displayFilms(data.films || []);
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            }
        }

        async function loadTop250() {
            showLoading();
            try {
                const response = await fetch('https://kinopoiskapiunofficial.tech/api/v2.2/films/top?type=TOP_250_BEST_FILMS&page=1', {
                    headers: { 'X-API-KEY': API_KEY_DECODED }
                });
                const data = await response.json();
                displayFilms(data.films || []);
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            }
        }

        async function loadNew() {
            showLoading();
            try {
                const response = await fetch('https://kinopoiskapiunofficial.tech/api/v2.2/films/premieres?year=2025&month=NOVEMBER', {
                    headers: { 'X-API-KEY': API_KEY_DECODED }
                });
                const data = await response.json();
                displayFilms(data.items || []);
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            }
        }

        async function loadRandom() {
            showLoading();
            try {
                const page = Math.floor(Math.random() * 10) + 1;
                const response = await fetch(`https://kinopoiskapiunofficial.tech/api/v2.2/films/top?type=TOP_250_BEST_FILMS&page=${page}`, {
                    headers: { 'X-API-KEY': API_KEY_DECODED }
                });
                const data = await response.json();
                const films = data.films || [];
                if (films.length > 0) {
                    const randomFilm = films[Math.floor(Math.random() * films.length)];
                    openPlayer(randomFilm.filmId || randomFilm.kinopoiskId, randomFilm.nameRu || randomFilm.nameEn);
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            }
        }

        function displayFilms(films) {
            const container = document.getElementById('filmsContainer');
            container.innerHTML = '';

            films.slice(0, 10).forEach(film => {
                const filmId = film.filmId || film.kinopoiskId;
                const title = film.nameRu || film.nameEn || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                const year = film.year || '–ù/–î';
                const rating = film.rating || '–ù/–î';
                const poster = film.posterUrlPreview || '';

                const card = document.createElement('div');
                card.className = 'film-card';
                card.onclick = () => openPlayer(filmId, title);
                card.innerHTML = `
                    <img class="film-poster" src="${poster}" alt="${title}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%22120%22%3E%3Crect fill=%22%23667eea%22 width=%22100%25%22 height=%22100%25%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2230%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22%3Eüé¨%3C/text%3E%3C/svg%3E'">
                    <div class="film-info">
                        <div class="film-title">${title}</div>
                        <div class="film-meta">üìÖ ${year} ‚Ä¢ ‚≠ê ${rating}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openPlayer(filmId, title) {
            const url = `https://api.embess.ws/embed/kp/${filmId}?sharing=false&host=kinotut.me&token=0926b7296919955c8f9d1559ec54505a`;
            
            document.getElementById('playerTitle').textContent = title || '–§–∏–ª—å–º';
            document.getElementById('playerFrame').src = url;
            document.getElementById('playerOverlay').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
            
            tg.BackButton.show();
        }

        function closePlayer() {
            document.getElementById('playerOverlay').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            document.getElementById('playerFrame').src = '';
            
            tg.BackButton.hide();
        }

        function showLoading() {
            document.getElementById('filmsContainer').innerHTML = '<div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        }

        function showError(message) {
            document.getElementById('filmsContainer').innerHTML = `<div class="loading">‚ùå ${message}</div>`;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadPopular();
    </script>
</body>
</html>
