<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Genopoisk - –ü–æ–∏—Å–∫ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∏–ª—å–º–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      padding: 25px 0;
    }
    
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 30px 0;
    }
    
    .categories button {
      background: #fff;
      color: #333;
      border: none;
      padding: 20px;
      border-radius: 15px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .categories button:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    #loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2rem;
    }
    
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .random-preview {
      background: #fff;
      color: #333;
      border-radius: 20px;
      padding: 30px;
      margin: 30px 0;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .random-preview h3 {
      font-size: 1.8rem;
      margin-bottom: 15px;
    }
    
    .random-preview .film-meta {
      font-size: 1.1rem;
      color: #666;
      margin: 15px 0;
    }
    
    .random-preview button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      border: none;
      padding: 15px 40px;
      font-size: 1.1rem;
      border-radius: 30px;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s;
    }
    
    .random-preview button:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .films-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    
    .film-card {
      background: #fff;
      border-radius: 15px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .film-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    }
    
    .film-poster {
      width: 100%;
      height: 270px;
      object-fit: cover;
    }
    
    .film-info {
      padding: 15px;
      color: #333;
    }
    
    .film-title {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    
    .film-details {
      font-size: 0.85rem;
      color: #666;
    }
    
    #playerContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 1000;
    }
    
    .player-header {
      background: rgba(255,255,255,0.1);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    #playerTitle {
      color: #fff;
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    .player-header button {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
    }
    
    #playerFrame {
      width: 100%;
      height: calc(100% - 60px);
      border: none;
    }
    
    footer {
      text-align: center;
      padding: 30px;
      margin-top: 40px;
      opacity: 0.8;
    }
    
    @media (max-width: 768px) {
      .categories {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .films-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè≠ Genopoisk</h1>
      <p>–ü–æ–∏—Å–∫ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∏–ª—å–º–æ–≤ –æ–Ω–ª–∞–π–Ω</p>
    </div>
    
    <div class="categories">
      <button onclick="loadCategory('popular')">üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</button>
      <button onclick="loadCategory('top250')">‚≠ê –¢–æ–ø 250</button>
      <button onclick="loadCategory('new')">üé¨ –ù–æ–≤–∏–Ω–∫–∏</button>
      <button onclick="loadCategory('random')">üéØ –°–ª—É—á–∞–π–Ω—ã–π</button>
    </div>
    
    <div id="loading" style="display:none;">
      <div class="spinner"></div>
      <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
    
    <div id="randomPreview"></div>
    <div id="filmsGrid" class="films-grid"></div>
  </div>
  
  <div id="playerContainer" style="display:none;">
    <div class="player-header">
      <div id="playerTitle"></div>
      <button onclick="closePlayer()">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <iframe id="playerFrame"></iframe>
  </div>
  
  <footer>
    <p>Powered by Kinopoisk API</p>
  </footer>
  
  <script>
    // API Configuration
    const API_KEY = '33b1e3bd-2643-4ac1-8eb4-6b7392c5e913';
    const API_BASE = 'https://kinopoiskapiunofficial.tech/api';
    
    let currentPage = 1;
    let currentCategory = null;
    let isLoading = false;
    let hasMore = true;
    
    // API Helper
    async function apiGet(url) {
      try {
        const res = await fetch(url, {
          headers: { 'X-API-KEY': API_KEY }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }
    
    // Load Category
    async function loadCategory(category) {
      currentCategory = category;
      currentPage = 1;
      hasMore = true;
      document.getElementById('filmsGrid').innerHTML = '';
      document.getElementById('randomPreview').innerHTML = '';
      
      if (category === 'random') {
        await loadRandomFilm();
      } else {
        await loadMoreFilms();
      }
    }
    
    // Load Random Film
    async function loadRandomFilm() {
      showLoading();
      try {
        const randomPage = Math.floor(Math.random() * 5) + 1;
        const url = `${API_BASE}/v2.2/films/top?type=TOP_250_BEST_FILMS&page=${randomPage}`;
        const data = await apiGet(url);
        const films = data.items || data.films || [];
        
        if (films.length > 0) {
          const randomFilm = films[Math.floor(Math.random() * films.length)];
          displayRandomFilm(randomFilm);
        }
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
      } finally {
        hideLoading();
      }
    }
    
    // Display Random Film
    function displayRandomFilm(film) {
      const filmId = film.filmId || film.kinopoiskId;
      const title = film.nameRu || film.nameEn || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      const year = film.year || '–ù/–î';
      const rating = film.rating || film.ratingKinopoisk || '–ù/–î';
      const genres = (film.genres || []).map(g => typeof g === 'object' ? g.genre : g).join(', ') || '–ù/–î';
      
      const preview = document.getElementById('randomPreview');
      preview.innerHTML = `
        <div class="random-preview">
          <h3>${title}</h3>
          <div class="film-meta">
            <div>üìÖ ${year}</div>
            <div>‚≠ê –†–µ–π—Ç–∏–Ω–≥: ${rating}</div>
            <div>üé≠ –ñ–∞–Ω—Ä—ã: ${genres}</div>
          </div>
          <button onclick="playFilm(${filmId}, '${title.replace(/'/g, "\\'")}')">–°–º–æ—Ç—Ä–µ—Ç—å</button>
        </div>
      `;
    }
    
    // Load More Films
    async function loadMoreFilms() {
      if (isLoading || !hasMore) return;
      
      isLoading = true;
      showLoading();
      
      try {
        let url = '';
        const currentYear = new Date().getFullYear();
        
        if (currentCategory === 'popular') {
          url = `${API_BASE}/v2.2/films/top?type=TOP_100_POPULAR_FILMS&page=${currentPage}`;
        } else if (currentCategory === 'top250') {
          url = `${API_BASE}/v2.2/films/top?type=TOP_250_BEST_FILMS&page=${currentPage}`;
        } else if (currentCategory === 'new') {
          url = `${API_BASE}/v2.2/films?order=NUM_VOTE&type=FILM&ratingFrom=0&ratingTo=10&yearFrom=${currentYear}&yearTo=${currentYear}&page=${currentPage}`;
        }
        
        const data = await apiGet(url);
        const films = data.items || data.films || [];
        
        if (films.length > 0) {
          displayFilms(films);
          currentPage++;
        } else {
          hasMore = false;
        }
      } catch (error) {
        if (currentPage === 1) {
          alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
      } finally {
        isLoading = false;
        hideLoading();
      }
    }
    
    // Display Films
    function displayFilms(films) {
      const container = document.getElementById('filmsGrid');
      
      films.forEach(film => {
        const filmId = film.filmId || film.kinopoiskId;
        const title = film.nameRu || film.nameEn || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        const year = film.year || '–ù/–î';
        const rating = film.rating || film.ratingKinopoisk || '–ù/–î';
        const poster = film.posterUrlPreview || film.posterUrl || '';
        
        const card = document.createElement('div');
        card.className = 'film-card';
        card.innerHTML = `
          <img src="${poster}" class="film-poster" onerror="this.style.display='none'" alt="${title}">
          <div class="film-info">
            <div class="film-title">${title}</div>
            <div class="film-details">${year} ‚Ä¢ ‚≠ê ${rating}</div>
          </div>
        `;
        card.onclick = () => playFilm(filmId, title);
        container.appendChild(card);
      });
    }
    
    // Play Film
    function playFilm(filmId, title) {
      filmId = String(filmId).trim();
      if (!filmId || filmId === 'undefined' || !filmId.match(/^\d+$/)) {
        alert('–û—à–∏–±–∫–∞: –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π ID —Ñ–∏–ª—å–º–∞');
        return;
      }
      
      const playerFrame = document.getElementById('playerFrame');
      playerFrame.src = '';
      
      setTimeout(() => {
        playerFrame.src = `https://api.embess.ws/embed/kp/${filmId}`;
        document.getElementById('playerTitle').textContent = title;
        document.getElementById('playerContainer').style.display = 'block';
        document.body.style.overflow = 'hidden';
      }, 50);
    }
    
    // Close Player
    function closePlayer() {
      document.getElementById('playerFrame').src = '';
      document.getElementById('playerContainer').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    // Loading
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }
    
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }
    
    // Infinite Scroll
    window.addEventListener('scroll', () => {
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
        if (currentCategory && currentCategory !== 'random') {
          loadMoreFilms();
        }
      }
    });
  </script>
</body>
</html>