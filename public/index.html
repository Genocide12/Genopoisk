<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1, minimum-scale=1">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Genopoisk">
  <title>Genopoisk — смотреть фильмы онлайн бесплатно в хорошем качестве</title>
  <!-- остальные мета теги остаются без изменений -->
  <meta name="description" content="Смотрите фильмы онлайн бесплатно на Genopoisk. Большой каталог фильмов в хорошем качестве: новинки, топ 250, популярные фильмы без рекламы.">
  <meta name="keywords" content="смотреть фильмы онлайн, фильмы бесплатно, кино в хорошем качестве, новинки кино, топ фильмов, кинопоиск, genopoisk, топ 250, смотреть кино без рекламы">
  <meta property="og:title" content="Genopoisk — смотреть фильмы онлайн бесплатно">
  <meta property="og:description" content="Большой каталог фильмов в хорошем качестве без рекламы">
  <meta property="og:image" content="https://genopoisk.vercel.app/icon-192.png">
  <meta property="og:url" content="https://genopoisk.vercel.app/">
  <meta property="og:type" content="website">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <style>
    /* CSS остается без изменений */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
    /* ... весь существующий CSS ... */
  </style>
</head>
<body>
  <!-- HTML структура остается без изменений -->
  <div class="container">
    <!-- ... весь существующий HTML ... -->
  </div>
  
  <script>
    // Защита от контекстного меню и копирования остается
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('copy', e => e.preventDefault());
    document.addEventListener('cut', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());
    
    document.onkeydown = function(e) {
      const key = e.key || '';
      if (e.ctrlKey && (key === 'c' || key === 'C' || key === 'x' || key === 'X' || key === 'u' || key === 'U' || key === 's' || key === 'S')) {
        e.preventDefault();
        return false;
      }
      if (key === 'F12') {
        e.preventDefault();
        return false;
      }
    };

    // === НОВЫЕ ФУНКЦИИ ЗАЩИТЫ ССЫЛОК ===
    
    // Генерация timestamp для 24ч срока действия
    function generateTimestamp() {
      return Math.floor(Date.now() / 1000 / 86400); // День в формате unix
    }
    
    // Хэш для проверки целостности (простой но эффективный)
    function generateHash(filmId, timestamp) {
      const secret = 'GenopoiskSecret2026';
      const data = `${filmId}:${timestamp}:${secret}`;
      let hash = 0;
      for (let i = 0; i < data.length; i++) {
        const char = data.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return Math.abs(hash).toString(36).slice(0, 8).toUpperCase();
    }
    
    // Кодирование ID в base64url
    function encodeFilmId(filmId) {
      return btoa(filmId).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }
    
    // Декодирование и проверка ссылки
    function decodeAndValidateLink(p, h, timestamp) {
      try {
        const decodedId = atob(p.replace(/-/g, '+').replace(/_/g, '/'));
        const expectedHash = generateHash(decodedId, timestamp);
        return decodedId === parseInt(decodedId) && expectedHash === h;
      } catch (e) {
        return false;
      }
    }
    
    // Генерация защищенной ссылки
    function generateProtectedLink(filmId, title) {
      const timestamp = generateTimestamp();
      const encodedId = encodeFilmId(filmId);
      const hash = generateHash(filmId, timestamp);
      return `player.html?p=${encodedId}&h=${hash}&t=${timestamp}&title=${encodeURIComponent(title)}`;
    }
    
    // НОВЫЙ openPlayer с защитой
    function openPlayer(filmId, title) {
      const protectedLink = generateProtectedLink(filmId, title);
      window.location.href = protectedLink;
    }

    // === ОСНОВНОЙ КОД ПРИЛОЖЕНИЯ (без изменений) ===
    const API_KEY = '3698ed63-120c-4285-8071-2811619a0a7c';
    const API_BASE = 'https://kinopoiskapiunofficial.tech/api';

    let currentCategory = null;
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;
    const filmDescriptions = new Map();

    const content = document.getElementById('content');
    const loader = document.getElementById('loader');
    const filmGrid = document.getElementById('filmGrid');
    const searchInput = document.getElementById('searchInput');

    // Проверка срока действия ссылки при загрузке страницы
    window.addEventListener('load', function() {
      const params = new URLSearchParams(window.location.search);
      const p = params.get('p');
      const h = params.get('h');
      const t = params.get('t');
      
      if (p && h && t) {
        const currentTimestamp = generateTimestamp();
        const linkTimestamp = parseInt(t);
        
        // Проверка: ссылка не старше 1 дня
        if (currentTimestamp > linkTimestamp + 1) {
          window.location.href = 'index.html';
          return;
        }
      }
    });

    // Остальные функции без изменений
    function toggleTheme() {
      const body = document.body;
      const isLight = body.classList.contains('light-theme');
      body.classList.toggle('light-theme');
      localStorage.setItem('theme', isLight ? 'dark' : 'light');
      const metaTheme = document.querySelector('meta[name="theme-color"]');
      if (metaTheme) metaTheme.content = isLight ? '#000000' : '#F2F2F7';
    }

    if (localStorage.getItem('theme') === 'light') {
      document.body.classList.add('light-theme');
      const metaTheme = document.querySelector('meta[name="theme-color"]');
      if (metaTheme) metaTheme.content = '#F2F2F7';
    }

    // Все остальные функции API остаются без изменений
    async function apiGet(url) {
      try {
        const res = await fetch(url, {
          headers: {
            'X-API-KEY': API_KEY,
            'Content-Type': 'application/json'
          }
        });
        if (!res.ok) throw new Error('HTTP ' + res.status + ': ' + res.statusText);
        return await res.json();
      } catch (e) {
        console.error('API Error:', e);
        throw e;
      }
    }

    // ... остальные функции без изменений (getPopular, getTop250, getNew, etc.) ...

    // В displayFilms функция клика теперь использует новую openPlayer
    async function displayFilms(films, append = false) {
      // ... код без изменений до обработчиков событий ...
      
      for (const film of films) {
        const filmId = film.filmId || film.kinopoiskId;
        const title = film.nameRu || film.nameEn || 'Без названия';
        // ... создание карточки ...
        
        // Клик теперь использует защищенную openPlayer
        card.addEventListener('click', () => {
          openPlayer(filmId, title);
        });
        
        // ... остальной код touch/mouse событий использует тот же filmId и title ...
      }
    }

    // Все остальные функции остаются без изменений
    // loadCategory, loadMoreFilms, search и т.д.

    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.expand();
      const themeParams = window.Telegram.WebApp.themeParams;
      if (themeParams?.bg_color) {
        const metaTheme = document.querySelector('meta[name="theme-color"]');
        if (metaTheme) metaTheme.content = themeParams.bg_color;
      }
    }
  </script>
</body>
</html>
