<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1, minimum-scale=1" />
  <title>Player</title>
  <style>
    html, body {
      -webkit-user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent;
      user-select: none; -moz-user-select: none; -ms-user-select: none;
      margin: 0; padding: 0; background: #000; width: 100vw; height: 100vh;
      min-height: 100vh; min-width: 100vw; font-family: system-ui, sans-serif; overflow: hidden;
    }

    .player-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      z-index: 10;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .title {
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 60%;
    }

    .btn-group {
      display: flex;
      gap: 10px;
    }

    button {
      background: rgba(255, 255, 255, 0.14);
      border: none;
      color: #fff;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    button:active { transform: scale(0.95); opacity: 0.8; }
    .btn-close { background: rgba(255, 59, 48, 0.3); }

    .player-main {
      width: 100%;
      height: 100%;
      padding-top: 60px; /* –í—ã—Å–æ—Ç–∞ —Ö–µ–¥–µ—Ä–∞ */
    }

    .player-iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    /* Error Screen */
    .error-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      color: white;
      text-align: center;
      padding: 20px;
      background: #000;
    }
  </style>
</head>
<body>
  <div class="player-header">
    <span class="title" id="videoTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    <div class="btn-group">
      <button id="playerToggle" class="player-toggle">–î—Ä—É–≥–æ–π –ø–ª–µ–µ—Ä</button>
      <button class="btn btn-close" onclick="goToIndex()">–ù–∞–∑–∞–¥</button>
    </div>
  </div>
  <div class="player-main">
    <iframe id="playerIframe" class="player-iframe" allowfullscreen allow="autoplay; fullscreen; picture-in-picture"></iframe>
  </div>

  <script>
    // === –ó–ê–©–ò–¢–ê ===
    document.addEventListener("contextmenu", (e) => e.preventDefault());
    document.addEventListener("copy", (e) => e.preventDefault());
    document.addEventListener("cut", (e) => e.preventDefault());
    document.addEventListener("selectstart", (e) => e.preventDefault());
    document.onkeydown = function (e) {
      if (e.ctrlKey && (e.key === "c" || e.key === "C" || e.key === "x" || e.key === "X" || e.key === "u" || e.key === "U" || e.key === "s" || e.key === "S")) return false;
      if (e.key === "F12") return false;
    };

    // === –ü–†–û–í–ï–†–ö–ê –ó–ê–©–ò–©–Å–ù–ù–û–ô –°–°–´–õ–ö–ò ===
    const SECRET_KEY = 'Genopoisk2026!x7K9pM2v'; // –¢–æ—Ç –∂–µ –∫–ª—é—á, —á—Ç–æ –≤ index.html!
    
    function verifySecureLink() {
      const params = new URLSearchParams(window.location.search);
      const p = params.get('p');
      const h = params.get('h');
      
      if (!p || !h) {
        showError('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞ –∏–ª–∏ –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω');
        return null;
      }
      
      try {
        // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        const data = atob(p);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ö–µ—à —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
        const expectedHash = btoa(data + SECRET_KEY).slice(0, 16);
        
        if (h !== expectedHash) {
          showError('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω (–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∏)');
          return null;
        }
        
        // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
        const parts = data.split('|');
        if (parts.length !== 3) {
          showError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
          return null;
        }
        
        const [kid, title, timestamp] = parts;
        const age = Date.now() - parseInt(timestamp);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ (24 —á–∞—Å–∞)
        if (age > 24 * 60 * 60 * 1000) {
          showError('–°—Å—ã–ª–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞ (–±–æ–ª–µ–µ 24 —á–∞—Å–æ–≤)');
          return null;
        }
        
        return { kid, title };
      } catch (e) {
        console.error(e);
        showError('–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Å—Å—ã–ª–∫–∏');
        return null;
      }
    }

    function showError(msg) {
      document.body.innerHTML = `
        <div class="error-screen">
          <div style="font-size: 40px; margin-bottom: 20px;">üîí</div>
          <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞</div>
          <div style="color: #888; margin-bottom: 30px;">${msg}</div>
          <button onclick="window.location.href='index.html'" style="background:#f33;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:16px;cursor:pointer;">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
        </div>`;
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    const paramsData = verifySecureLink();
    if (!paramsData) return; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞
    
    const kid = paramsData.kid;
    const title = paramsData.title;
    
    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –æ–Ω –±—ã–ª –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω)
    try {
      document.getElementById("videoTitle").textContent = decodeURIComponent(title);
    } catch(e) {
      document.getElementById("videoTitle").textContent = title;
    }

    const iframe = document.getElementById("playerIframe");
    const toggleBtn = document.getElementById("playerToggle");
    let isDefaultPlayer = true;

    function goToIndex() {
      window.location.href = 'index.html';
    }

    // === –£–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–õ–ï–ï–†–û–í ===
    function getBestPlayerUrl(kid, title) {
      const kidNum = parseInt(kid);
      const decodedTitle = decodeURIComponent(title);
      
      // –õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ ID –º–∞–ª–µ–Ω—å–∫–∏–π –∏–ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –µ—Å—Ç—å "1+1" –∏–ª–∏ "+", –∏—â–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
      if (kidNum < 100000 || decodedTitle.includes('1+1') || decodedTitle.includes('+')) {
        // –ó–∞–º–µ–Ω—è–µ–º "+" –Ω–∞ "1+1" –¥–ª—è –ø–æ–∏—Å–∫–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –∏–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
        const searchQuery = decodedTitle.replace(/\+/g, '1+1');
        return `https://ddbb.lol/search?q=${encodeURIComponent(searchQuery)}`;
      }
      // –ò–Ω–∞—á–µ –∏—â–µ–º –ø–æ ID
      return `https://ddbb.lol/?id=${kid}&n=0`;
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    iframe.src = `https://api.embess.ws/embed/kp/${kid}`;

    // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
    toggleBtn.addEventListener('click', function() {
      isDefaultPlayer = !isDefaultPlayer;
      if (isDefaultPlayer) {
        // –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä
        iframe.src = `https://api.embess.ws/embed/kp/${kid}`;
        toggleBtn.textContent = '–î—Ä—É–≥–æ–π –ø–ª–µ–µ—Ä';
        toggleBtn.style.background = 'rgba(255,255,255,0.14)';
      } else {
        // –†–µ–∑–µ—Ä–≤–Ω—ã–π —É–º–Ω—ã–π –ø–ª–µ–µ—Ä
        const ddbbUrl = getBestPlayerUrl(kid, title);
        iframe.src = ddbbUrl;
        toggleBtn.textContent = '–û—Å–Ω–æ–≤–Ω–æ–π';
        toggleBtn.style.background = 'rgba(50,150,225,0.3)';
      }
    });

    // Telegram WebApp
    window.Telegram?.WebApp?.expand?.();
    window.Telegram?.WebApp?.setHeaderColor?.("#000000");
    window.Telegram?.WebApp?.setBackgroundColor?.("#000000");
  </script>
</body>
</html>
