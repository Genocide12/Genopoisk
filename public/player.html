<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- head без изменений -->
</head>
<body>
  <!-- HTML без изменений -->
  
  <script>
    // === ПОЛНАЯ ЗАЩИТА ПЛЕЕРА ===
    
    // Проверка параметров при загрузке
    window.addEventListener('load', function() {
      const params = new URLSearchParams(window.location.search);
      
      // Блокировка без параметров
      if (!params.get('p') || !params.get('h') || !params.get('t')) {
        window.location.href = 'index.html';
        return;
      }
      
      // Декодирование и проверка
      const p = params.get('p');
      const h = params.get('h');
      const t = params.get('t');
      
      function generateTimestamp() {
        return Math.floor(Date.now() / 1000 / 86400);
      }
      
      function generateHash(filmId, timestamp) {
        const secret = 'GenopoiskSecret2026';
        const data = `${filmId}:${timestamp}:${secret}`;
        let hash = 0;
        for (let i = 0; i < data.length; i++) {
          const char = data.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        return Math.abs(hash).toString(36).slice(0, 8).toUpperCase();
      }
      
      function decodeFilmId(encoded) {
        try {
          return atob(encoded.replace(/-/g, '+').replace(/_/g, '/'));
        } catch (e) {
          return null;
        }
      }
      
      const decodedId = decodeFilmId(p);
      const currentTimestamp = generateTimestamp();
      
      // Проверки безопасности
      if (!decodedId || isNaN(decodedId) || 
          currentTimestamp > parseInt(t) + 1 || // > 24ч
          generateHash(decodedId, t) !== h) {
        window.location.href = 'index.html';
        return;
      }
      
      // Установка kid для плеера
      window.kid = decodedId;
    });

    // Остальной код плеера с заменой получения kid
    document.addEventListener("contextmenu", (e) => e.preventDefault());
    // ... остальные защиты ...

    function goToIndex() {
      window.location.href = 'index.html';
    }

    const params = new URLSearchParams(window.location.search);
    const title = params.get("title") || "";
    document.getElementById("videoTitle").textContent = decodeURIComponent(title);

    const iframe = document.getElementById("playerIframe");
    const toggleBtn = document.getElementById("playerToggle");

    let isDefaultPlayer = true;

    // Ждем загрузки kid и устанавливаем плеер
    function initPlayer() {
      if (!window.kid) {
        setTimeout(initPlayer, 100);
        return;
      }
      
      iframe.src = `https://api.embess.ws/embed/kp/${window.kid}`;
      
      toggleBtn.addEventListener('click', function() {
        isDefaultPlayer = !isDefaultPlayer;
        if (isDefaultPlayer) {
          iframe.src = `https://api.embess.ws/embed/kp/${window.kid}`;
          toggleBtn.textContent = 'Другой плеер';
        } else {
          iframe.src = `https://ddbb.lol/?id=${window.kid}&n=0`;
          toggleBtn.textContent = 'Основной';
        }
      });
    }

    initPlayer();
    
    // Telegram WebApp
    window.Telegram?.WebApp?.expand?.();
    window.Telegram?.WebApp?.setHeaderColor?.("#000000");
    window.Telegram?.WebApp?.setBackgroundColor?.("#000000");
  </script>
</body>
</html>
